{% extends 'base/base.html' %}
{% load static %}

{% block title %}Bulk Upload PGs - SIMS{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <h1 class="h3 mb-0">
        <i class="fas fa-upload me-2"></i>
        Bulk Upload Postgraduates
    </h1>
    <div>
        <a href="{% url 'users:pg_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to PG List
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Instructions Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Upload Instructions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">Upload an Excel file (.xlsx or .xls) containing trainee data. The file should include the following columns:</p>
                    <ul class="mb-3">
                        <li><strong>Sr. No.</strong> - Serial number (optional, will be ignored)</li>
                        <li><strong>Name of Trainee</strong> - Full name of the trainee (required)</li>
                        <li><strong>Date of Joining</strong> - Date when trainee joined (required, format: YYYY-MM-DD or DD/MM/YYYY)</li>
                        <li><strong>MS/FCPS</strong> - Qualification (optional)</li>
                        <li><strong>Supervisor Name</strong> - Name of the supervisor (optional, will create supervisor if not found)</li>
                    </ul>
                    <div class="d-flex gap-2 mb-3">
                        <a href="{% url 'users:trainee_template_download' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-download me-2"></i>Download Template File
                        </a>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> The system will create user accounts automatically. If a supervisor name is provided but doesn't exist, a supervisor account will be created automatically.
                    </div>
                </div>
            </div>

            <!-- Excel Converter Card -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>Convert Excel File to Required Format
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">Have an Excel file with different column names? Convert it to the required format automatically.</p>
                    <form id="excelConverterForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="convert_file" class="form-label">Select Excel File to Convert</label>
                            <input type="file" class="form-control" id="convert_file" name="file" accept=".xlsx,.xls" required>
                            <div class="form-text">The system will automatically map columns to the required format.</div>
                        </div>
                        <button type="submit" class="btn btn-secondary" id="convertBtn">
                            <i class="fas fa-exchange-alt me-2"></i>Convert and Download
                        </button>
                    </form>
                </div>
            </div>

            <!-- Upload Form Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-upload me-2"></i>Upload File
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="bulkUploadForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="id_file" class="form-label">Select Excel File</label>
                            <input type="file" class="form-control" id="id_file" name="file" accept=".xlsx,.xls" required>
                            <div class="form-text">Accepted formats: .xlsx, .xls (Max size: 5MB)</div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="id_dry_run" name="dry_run" checked>
                                <label class="form-check-label" for="id_dry_run">
                                    <strong>Dry Run Mode</strong> - Preview changes without saving (recommended for first upload)
                                </label>
                            </div>
                            <div class="form-text">When enabled, the system will validate the file and show what would be imported without actually creating users.</div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="id_allow_partial" name="allow_partial">
                                <label class="form-check-label" for="id_allow_partial">
                                    <strong>Allow Partial Import</strong> - Import valid rows even if some rows have errors
                                </label>
                            </div>
                            <div class="form-text">When enabled, rows with errors will be skipped but valid rows will still be imported.</div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-success" id="uploadBtn">
                                <i class="fas fa-upload me-2"></i>Upload and Process
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Card (shown after upload) -->
            <div class="card mt-4" id="resultsCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>Upload Results
                    </h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#bulkUploadForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const uploadBtn = $('#uploadBtn');
        const originalText = uploadBtn.html();
        
        // Disable button and show loading
        uploadBtn.prop('disabled', true);
        uploadBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Processing...');
        
        // Show results card
        $('#resultsCard').show();
        $('#resultsContent').html('<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Processing file...</p></div>');
        
        $.ajax({
            url: '{% url "users:pg_bulk_upload" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    let html = '<div class="alert alert-success"><h5><i class="fas fa-check-circle me-2"></i>Upload Successful!</h5>';
                    html += '<p class="mb-2"><strong>Total rows processed:</strong> ' + response.total_items + '</p>';
                    html += '<p class="mb-2"><strong>Successfully imported:</strong> <span class="text-success">' + response.success_count + '</span></p>';
                    
                    if (response.failure_count > 0) {
                        html += '<p class="mb-2"><strong>Failed:</strong> <span class="text-danger">' + response.failure_count + '</span></p>';
                    }
                    
                    html += '</div>';
                    
                    if (response.details && response.details.failures && response.details.failures.length > 0) {
                        html += '<div class="alert alert-warning mt-3"><h6>Errors Found:</h6><ul class="mb-0">';
                        response.details.failures.forEach(function(failure) {
                            let errorMsg = '';
                            if (typeof failure.error === 'object') {
                                errorMsg = JSON.stringify(failure.error);
                            } else {
                                errorMsg = failure.error || 'Unknown error';
                            }
                            html += '<li><strong>Row ' + (failure.row || 'unknown') + ':</strong> ' + errorMsg + '</li>';
                        });
                        html += '</ul></div>';
                    }
                    
                    if (response.details && response.details.successes && response.details.successes.length > 0 && !response.dry_run) {
                        html += '<div class="alert alert-info mt-3"><h6>Successfully Created:</h6><ul class="mb-0">';
                        response.details.successes.slice(0, 10).forEach(function(success) {
                            html += '<li>' + success.name + ' (Username: ' + success.username + ')</li>';
                        });
                        if (response.details.successes.length > 10) {
                            html += '<li><em>... and ' + (response.details.successes.length - 10) + ' more</em></li>';
                        }
                        html += '</ul></div>';
                    }
                    
                    if (response.dry_run) {
                        html += '<div class="alert alert-info mt-3"><i class="fas fa-info-circle me-2"></i>This was a dry run. No users were actually created. Uncheck "Dry Run Mode" to perform the actual import.</div>';
                    } else {
                        html += '<div class="mt-3"><a href="{% url "users:pg_list" %}" class="btn btn-primary"><i class="fas fa-list me-2"></i>View PG List</a></div>';
                    }
                    
                    $('#resultsContent').html(html);
                } else {
                    let errorHtml = '<div class="alert alert-danger"><h5><i class="fas fa-exclamation-triangle me-2"></i>Upload Failed</h5><p>' + (response.error || 'An error occurred during upload') + '</p>';
                    
                    // Show detailed error information if available
                    if (response.details && response.details.failures && response.details.failures.length > 0) {
                        errorHtml += '<div class="mt-3"><h6>Error Details:</h6><ul class="mb-0">';
                        response.details.failures.forEach(function(failure) {
                            let errorMsg = '';
                            if (typeof failure.error === 'object') {
                                errorMsg = JSON.stringify(failure.error);
                            } else {
                                errorMsg = failure.error || 'Unknown error';
                            }
                            errorHtml += '<li><strong>Row ' + (failure.row || 'unknown') + ':</strong> ' + errorMsg;
                            if (failure.data) {
                                errorHtml += '<br><small class="text-muted">Data: ' + JSON.stringify(failure.data) + '</small>';
                            }
                            errorHtml += '</li>';
                        });
                        errorHtml += '</ul></div>';
                    }
                    
                    errorHtml += '</div>';
                    $('#resultsContent').html(errorHtml);
                }
            },
                error: function(xhr) {
                let errorMsg = 'An error occurred during upload';
                let errorDetails = null;
                
                if (xhr.responseJSON) {
                    errorMsg = xhr.responseJSON.error || errorMsg;
                    errorDetails = xhr.responseJSON.details;
                } else if (xhr.responseText) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMsg = response.error || errorMsg;
                        errorDetails = response.details;
                    } catch(e) {
                        errorMsg = xhr.responseText.substring(0, 200);
                    }
                }
                
                let errorHtml = '<div class="alert alert-danger"><h5><i class="fas fa-exclamation-triangle me-2"></i>Upload Failed</h5><p>' + errorMsg + '</p>';
                
                // Show detailed error information if available
                if (errorDetails && errorDetails.failures && errorDetails.failures.length > 0) {
                    errorHtml += '<div class="mt-3"><h6>Error Details:</h6><ul class="mb-0">';
                    errorDetails.failures.forEach(function(failure) {
                        let failureMsg = '';
                        if (typeof failure.error === 'object') {
                            failureMsg = JSON.stringify(failure.error);
                        } else {
                            failureMsg = failure.error || 'Unknown error';
                        }
                        errorHtml += '<li><strong>Row ' + (failure.row || 'unknown') + ':</strong> ' + failureMsg;
                        if (failure.data) {
                            errorHtml += '<br><small class="text-muted">Data: ' + JSON.stringify(failure.data) + '</small>';
                        }
                        errorHtml += '</li>';
                    });
                    errorHtml += '</ul></div>';
                }
                
                errorHtml += '</div>';
                $('#resultsContent').html(errorHtml);
            },
            complete: function() {
                uploadBtn.prop('disabled', false);
                uploadBtn.html(originalText);
            }
        });
    });
    
    // File size validation
    $('#id_file').on('change', function() {
        const file = this.files[0];
        if (file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('File size exceeds 5MB limit. Please choose a smaller file.');
                $(this).val('');
            }
        }
    });
    
    // Excel converter form handler
    $('#excelConverterForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const convertBtn = $('#convertBtn');
        const originalText = convertBtn.html();
        
        // Disable button and show loading
        convertBtn.prop('disabled', true);
        convertBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Converting...');
        
        $.ajax({
            url: '{% url "users:excel_converter" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.responseType = 'blob';
                return xhr;
            },
            success: function(data, status, xhr) {
                // Get filename from Content-Disposition header
                const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                let filename = 'converted_trainee_template.xlsx';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Create download link
                const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                alert('File converted successfully! The converted file has been downloaded.');
            },
            error: function(xhr) {
                let errorMsg = 'An error occurred during conversion';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else if (xhr.responseText) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMsg = response.error || errorMsg;
                    } catch(e) {
                        errorMsg = xhr.responseText.substring(0, 200);
                    }
                }
                alert('Conversion failed: ' + errorMsg);
            },
            complete: function() {
                convertBtn.prop('disabled', false);
                convertBtn.html(originalText);
                $('#convert_file').val('');
            }
        });
    });
    
    // File size validation for converter
    $('#convert_file').on('change', function() {
        const file = this.files[0];
        if (file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('File size exceeds 5MB limit. Please choose a smaller file.');
                $(this).val('');
            }
        }
    });
});
</script>
{% endblock %}
